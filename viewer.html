<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>View Image</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="js/exifr.min.js"></script>
  <style>
    body {
      max-width: 800px;
      margin: 2rem auto;
      font-family: sans-serif;
      padding: 1rem;
    }
    img {
      width: 100%;
      max-height: 80vh;
      object-fit: contain;
      margin-bottom: 1rem;
    }
    .meta p {
      margin: 0.5em 0;
      line-height: 1.5;
    }
    .back-link {
      display: inline-block;
      margin-bottom: 1em;
    }
  </style>
</head>
<body>
  <a class="back-link" href="index.html">&larr; Back to Gallery</a>
  <div id="image-container"></div>
  <div class="meta" id="meta"></div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const filename = params.get("img");

    if (!filename) {
      document.getElementById("image-container").innerHTML = "<p>No image specified.</p>";
    } else {
      const imgPath = `images/${filename}`;
      const container = document.getElementById("image-container");
      container.innerHTML = `<img src="${imgPath}" alt="${filename}">`;

      exifr.parse(imgPath, { tiff: true, xmp: true, userComment: true })
        .then(metadata => {
          const rawText = metadata?.parameters || metadata?.UserComment || "";
          const prompt = rawText.match(/^(.*?)Steps:/s)?.[1]?.trim() || "No prompt";
          const checkpoint = rawText.match(/Model:\s*([^\n,]+)/)?.[1]?.trim() || "Unknown";
          const loras = [...rawText.matchAll(/<lora:([\w-]+):([\d.]+)>/g)]
            .map(m => `${m[1]} (${m[2]})`)
            .join(', ') || "None";

          const metaDiv = document.getElementById("meta");
          metaDiv.innerHTML = `
            <p><strong>Filename:</strong> ${filename}</p>
            <p><strong>Checkpoint:</strong> ${checkpoint}</p>
            <p><strong>LoRA:</strong> ${loras}</p>
            <p><strong>Prompt:</strong><br>${prompt.replace(/\n/g, "<br>")}</p>
          `;
        })
        .catch(e => {
          document.getElementById("meta").innerHTML = `<p>Could not load metadata for ${filename}.</p>`;
          console.error("Metadata error:", e);
        });
    }
  </script>
</body>
</html>